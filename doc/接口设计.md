# Graph Agent æ™ºèƒ½ä½“APIæ¥å£è®¾è®¡æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

Graph Agent æ˜¯ä¸€ä¸ªåŸºäºSpring Bootçš„æ™ºèƒ½ä½“æµå¼èŠå¤©ä»£ç†æœåŠ¡ï¼Œæä¾›äº†å®Œæ•´çš„ç”¨æˆ·è®¤è¯ã€æµå¼èŠå¤©ä»£ç†å’ŒMCPå·¥å…·è°ƒç”¨ç»“æœæŸ¥è¯¢åŠŸèƒ½ã€‚

## åŸºç¡€ä¿¡æ¯

- **æœåŠ¡åç§°**: chat-stream-proxy-service
- **ç«¯å£**: 58220
- **åŸºç¡€URL**: http://localhost:58220
- **è®¤è¯æ–¹å¼**: JWT Token (Bearer Token)

## è®¤è¯ç³»ç»Ÿ

### 1. ç”¨æˆ·æ³¨å†Œ
**POST** `/api/auth/register`

æ³¨å†Œæ–°ç”¨æˆ·è´¦æˆ·ã€‚

**è¯·æ±‚ä½“**:
```json
{
  "username": "testuser",
  "password": "testpass123"
}
```

**å“åº”**:
```json
{
  "message": "æ³¨å†ŒæˆåŠŸ",
  "username": "testuser"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "ç”¨æˆ·åå·²å­˜åœ¨"
}
```

### 2. ç”¨æˆ·ç™»å½•
**POST** `/api/auth/login`

ç”¨æˆ·ç™»å½•è·å–JWTè®¿é—®ä»¤ç‰Œã€‚

**è¯·æ±‚ä½“**:
```json
{
  "username": "testuser",
  "password": "testpass123"
}
```

**æˆåŠŸå“åº”**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiJ9...",
  "type": "Bearer",
  "username": "testuser"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
}
```

### 3. è®¤è¯æœåŠ¡çŠ¶æ€æ£€æŸ¥
**GET** `/api/auth/test`

æ£€æŸ¥è®¤è¯æœåŠ¡çŠ¶æ€ã€‚

**å“åº”**:
```json
{
  "message": "è®¤è¯æœåŠ¡æ­£å¸¸è¿è¡Œ",
  "timestamp": 1753325517105
}
```

## æµå¼èŠå¤©ä»£ç†

### 1. MCPå·¥å…·ç»“æœæµå¼æå–
**POST** `/api/chat/stream/proxy`

ğŸ”’ **éœ€è¦è®¤è¯**

åˆ†æèŠå¤©å¯¹è¯ï¼Œæå–æ™ºèƒ½ä½“è°ƒç”¨MCPå·¥å…·çš„ç»“æœï¼Œä½¿ç”¨Server-Sent Events (SSE) è¿›è¡Œæµå¼è¿”å›ã€‚

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
```

**è¯·æ±‚ä½“**:
```json
{
  "message": "è¯·å¸®æˆ‘åˆ†æä¸€ä¸‹æ˜æ˜Ÿä¹‹é—´çš„å…³ç³»",
  "thread_id": "analysis_1752819308392"
}
```

**å“åº”ç±»å‹**: `text/event-stream`

**å“åº”ç¤ºä¾‹**:
```
data:{"thread_id": "analysis_1752819308392", "agent": "coordinator", "id": "run-abc123", "role": "assistant", "content": "æ­£åœ¨åˆ†ææ˜æ˜Ÿå…³ç³»..."}

data:{"thread_id": "analysis_1752819308392", "agent": "coordinator", "id": "run-abc123", "role": "assistant", "content": "åˆ†æå®Œæˆ", "finish_reason": "stop"}
```

## MCPå·¥å…·ç»“æœæŸ¥è¯¢

### 1. æ ¹æ®å·¥å…·åç§°æŸ¥è¯¢ç»“æœ
**GET** `/api/mcp-tool-results/query`

ğŸ”’ **éœ€è¦è®¤è¯**

æ ¹æ®çº¿ç¨‹IDå’Œå·¥å…·åç§°æŸ¥è¯¢ç‰¹å®šçš„å·¥å…·æ‰§è¡Œç»“æœã€‚

**æŸ¥è¯¢å‚æ•°**:
- `threadId` (string, å¿…å¡«): çº¿ç¨‹ID
- `toolName` (string, å¿…å¡«): å·¥å…·åç§°

**è¯·æ±‚ç¤ºä¾‹**:
```
GET /api/mcp-tool-results/query?threadId=analysis_1752819308392&toolName=mutual_friend_between_stars
Authorization: Bearer <JWT_TOKEN>
```

**å“åº”**:
```json
[
  {
    "id": 1,
    "threadId": "analysis_1752819308392",
    "name": "mutual_friend_between_stars",
    "content": "å·¥å…·æ‰§è¡Œç»“æœå†…å®¹...",
    "timestamp": "2025-01-17T10:30:00"
  }
]
```

### 2. POSTæ–¹å¼æŸ¥è¯¢å·¥å…·ç»“æœ
**POST** `/api/mcp-tool-results/query`

ğŸ”’ **éœ€è¦è®¤è¯**

ä½¿ç”¨POSTæ–¹å¼æŸ¥è¯¢å·¥å…·æ‰§è¡Œç»“æœï¼Œæ”¯æŒå¤æ‚å‚æ•°ã€‚

**è¯·æ±‚ä½“**:
```json
{
  "thread_id": "analysis_1752819308392",
  "toolName": "mutual_friend_between_stars"
}
```

### 3. æŸ¥è¯¢çº¿ç¨‹æ‰€æœ‰å·¥å…·åç§°
**GET** `/api/mcp-tool-results/query/all`

ğŸ”’ **éœ€è¦è®¤è¯**

æŸ¥è¯¢æŒ‡å®šçº¿ç¨‹IDä¸‹çš„æ‰€æœ‰å·¥å…·åç§°ï¼ˆå»é‡ï¼‰ã€‚

**æŸ¥è¯¢å‚æ•°**:
- `threadId` (string, å¿…å¡«): çº¿ç¨‹ID

**å“åº”**:
```json
[
  {
    "name": "mutual_friend_between_stars",
    "count": 3
  },
  {
    "name": "entity_extraction",
    "count": 1
  }
]
```

### 4. æŸ¥è¯¢çº¿ç¨‹æ‰€æœ‰å·¥å…·è¯¦ç»†ç»“æœ
**GET** `/api/mcp-tool-results/query/all/details`

ğŸ”’ **éœ€è¦è®¤è¯**

æŸ¥è¯¢æŒ‡å®šçº¿ç¨‹IDä¸‹çš„æ‰€æœ‰å·¥å…·æ‰§è¡Œç»“æœï¼ˆåŒ…å«å®Œæ•´å†…å®¹ï¼‰ã€‚

**æŸ¥è¯¢å‚æ•°**:
- `threadId` (string, å¿…å¡«): çº¿ç¨‹ID

### 5. æ£€æŸ¥å·¥å…·ç»“æœæ˜¯å¦å­˜åœ¨
**GET** `/api/mcp-tool-results/exists`

ğŸ”’ **éœ€è¦è®¤è¯**

æ£€æŸ¥æŒ‡å®šçº¿ç¨‹æ˜¯å¦å­˜åœ¨å·¥å…·æ‰§è¡Œç»“æœã€‚

**æŸ¥è¯¢å‚æ•°**:
- `threadId` (string, å¿…å¡«): çº¿ç¨‹ID

**å“åº”**:
```json
{
  "threadId": "analysis_1752819308392",
  "exists": true,
  "timestamp": 1753325517105
}
```

### 6. æŸ¥è¯¢GraphCacheæ•°æ®
**GET** `/api/mcp-tool-results/query/graph-cache`

ğŸ”’ **éœ€è¦è®¤è¯**

æ ¹æ®çº¿ç¨‹IDæŸ¥è¯¢ç›¸å…³çš„å›¾è°±ç¼“å­˜æ•°æ®ã€‚å…ˆè·å–è¯¥threadIdçš„æ‰€æœ‰å·¥å…·ç»“æœï¼Œä»contentå­—æ®µæå–idï¼Œç„¶åæŸ¥è¯¢graph-cacheè¡¨ã€‚

**æŸ¥è¯¢å‚æ•°**:
- `threadId` (string, å¿…å¡«): çº¿ç¨‹ID

**å“åº”**:
```json
[
  {
    "id": "node_123",
    "type": "person",
    "properties": {
      "name": "å¼ ä¸‰",
      "age": 30
    },
    "cached_at": "2025-01-17T10:30:00"
  }
]
```

### 7. APIä½¿ç”¨ç¤ºä¾‹
**GET** `/api/mcp-tool-results/examples`

è·å–APIä½¿ç”¨ç¤ºä¾‹ï¼ˆç”¨äºæ–‡æ¡£å’Œè°ƒè¯•ï¼‰ã€‚

**å“åº”**:
```json
{
  "queryByToolName": {
    "url": "/api/mcp-tool-results/query?threadId=analysis_1752819308392&toolName=mutual_friend_between_stars",
    "method": "GET",
    "description": "æ ¹æ®çº¿ç¨‹IDå’Œå·¥å…·åç§°æŸ¥è¯¢ç»“æœ"
  },
  "queryByPost": {
    "url": "/api/mcp-tool-results/query",
    "method": "POST",
    "description": "POSTæ–¹å¼æŸ¥è¯¢ç»“æœ",
    "body": {
      "threadId": "analysis_1752819308392",
      "toolName": "mutual_friend_between_stars"
    }
  }
}
```

## è°ƒè¯•æ¥å£

### 1. GraphCacheè°ƒè¯•
**GET** `/api/mcp-tool-results/debug/graph-cache`

ğŸ”’ **éœ€è¦è®¤è¯**

æŸ¥çœ‹æŒ‡å®šthreadIdçš„è¯¦ç»†å¤„ç†è¿‡ç¨‹ï¼Œç”¨äºè°ƒè¯•ã€‚

### 2. GraphCacheæ•°æ®æ ·æœ¬
**GET** `/api/mcp-tool-results/debug/graph-cache-sample`

ğŸ”’ **éœ€è¦è®¤è¯**

æŸ¥çœ‹graph_cacheè¡¨ä¸­çš„å®é™…æ•°æ®æ ·æœ¬ã€‚

**æŸ¥è¯¢å‚æ•°**:
- `limit` (int, å¯é€‰): é™åˆ¶è¿”å›æ¡æ•°ï¼Œé»˜è®¤10æ¡

### 3. æ•°æ®åº“è¿æ¥è¯Šæ–­
**GET** `/api/mcp-tool-results/debug/database-connection`

ğŸ”’ **éœ€è¦è®¤è¯**

è¯Šæ–­æ•°æ®åº“è¿æ¥å’Œè¡¨è®¿é—®é—®é¢˜ã€‚

## é”™è¯¯å¤„ç†

### HTTPçŠ¶æ€ç 

- **200**: è¯·æ±‚æˆåŠŸ
- **400**: è¯·æ±‚å‚æ•°é”™è¯¯
- **401**: æœªè®¤è¯æˆ–Tokenæ— æ•ˆ
- **403**: æ²¡æœ‰æƒé™è®¿é—®èµ„æº
- **404**: èµ„æºä¸å­˜åœ¨
- **500**: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

### é”™è¯¯å“åº”æ ¼å¼

```json
{
  "timestamp": "2025-01-17T10:30:00.000+00:00",
  "status": 403,
  "error": "Forbidden",
  "path": "/api/chat/stream/proxy"
}
```

## è®¤è¯è¯´æ˜

### JWT Tokenä½¿ç”¨

1. é€šè¿‡ `/api/auth/login` è·å–JWT Token
2. åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ : `Authorization: Bearer <TOKEN>`
3. Tokenæœ‰æ•ˆæœŸ: 24å°æ—¶
4. Tokenè¿‡æœŸåéœ€è¦é‡æ–°ç™»å½•

### ä¿æŠ¤çš„ç«¯ç‚¹

- æ‰€æœ‰ `/api/chat/*` ç«¯ç‚¹
- æ‰€æœ‰ `/api/mcp-tool-results/*` ç«¯ç‚¹ï¼ˆé™¤äº† `/examples`ï¼‰

### å…¬å¼€ç«¯ç‚¹

- `/api/auth/*` - è®¤è¯ç›¸å…³æ¥å£
- `/api/mcp-tool-results/examples` - APIç¤ºä¾‹

## åŠŸèƒ½ç‰¹æ€§

1. **æ™ºèƒ½ä½“æµå¼æ•°æ®è§£æ**: å®æ—¶è§£æå’Œæå–MCPå·¥å…·è°ƒç”¨ç»“æœ
2. **å®ä½“æå–ä¸ç¼“å­˜**: æ ¹æ®ç”¨æˆ·è¾“å…¥è¿›è¡Œå®ä½“æå–
3. **å®ä½“éªŒè¯**: æ ¹æ®æ¨¡å‹æå–çš„å®ä½“å»å›¾æ•°æ®åº“æŸ¥è¯¢å®ä½“æ˜¯å¦å­˜åœ¨
4. **å®ä½“è¡¥å…¨**: æ ¹æ®æå–åˆ°çš„å®ä½“è¡¥å…¨å®ä½“ä¿¡æ¯è¡¥é½IDå­—æ®µ
5. **å®ä½“ç¼“å­˜**: å¹¶ä¿å­˜åˆ°ç¼“å­˜æ•°æ®åº“
6. **å›¾è°±æ•°æ®æŸ¥è¯¢**: æ”¯æŒä»ç¼“å­˜æ•°æ®åº“æŸ¥è¯¢å®ä½“æ•°æ®ï¼Œç”¨äºå¯è§†åŒ–å±•ç¤º
7. **å·¥å…·è°ƒç”¨æ ‡è¯†**: è§£æå¹¶ä¿å­˜æ™ºèƒ½ä½“æµå¼æ•°æ®ä¸­çš„MCPå·¥å…·è°ƒç”¨æ ‡è¯†
8. **å¤§è½¬ç›˜åŠŸèƒ½æ”¯æŒ**: æä¾›å·¥å…·æ ‡è¯†æŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒå¤§è½¬ç›˜åŠŸèƒ½
9. **å®æ—¶æ•°æ®å±•ç¤º**: è§£å†³æ•°æ®å›¾è°±å±•ç¤ºå»¶è¿Ÿé—®é¢˜ï¼Œæ”¯æŒè¿‡ç¨‹æ•°æ®å®æ—¶å±•ç¤º
10. **ä¸²è”æµç¨‹**: æ ¹æ®æ–°æ¥å£ä¿®æ”¹ä¸²è”æ•´ä¸ªæµç¨‹æµå¼è¾“å‡º

## å¼€å‘è¯´æ˜

### å¯åŠ¨æœåŠ¡
```bash
mvn spring-boot:run
```

### æ„å»ºé¡¹ç›®
```bash
mvn clean package
```

### æµ‹è¯•æ¥å£
å¯ä»¥ä½¿ç”¨Postmanæˆ–curlå·¥å…·æµ‹è¯•æ¥å£ï¼Œç¤ºä¾‹ï¼š

```bash
# 1. æ³¨å†Œç”¨æˆ·
curl -X POST http://localhost:58220/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser", "password": "testpass123"}'

# 2. ç™»å½•è·å–Token
curl -X POST http://localhost:58220/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser", "password": "testpass123"}'

# 3. ä½¿ç”¨Tokenè®¿é—®ä¿æŠ¤æ¥å£
curl -X POST http://localhost:58220/api/chat/stream/proxy \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"message": "test", "thread_id": "test123"}'
```
